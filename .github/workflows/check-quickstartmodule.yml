name: Check install matrix
on:
  push:
    branches:
      - site
  pull_request:
    paths:
      - assets/quick-start-module.js
      - _includes/quick-start-module.js
      - published_versions.json

jobs:
  check-regen:
    runs-on: ubuntu-18.04
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
          architecture: x64
      - name: Checkout Pytorch.github.io
        uses: actions/checkout@v2
      - name: Regen quick-start-module
        run: |
          python3 scripts/gen_quick_start_module.js >assets/quick-start-module.js
          CHANGES=$(git status --porcelain "assets/quick-start-module.js")
          echo "$CHANGES"
          [ -z "$CHANGES" ]
  libtorch-downloadable:
    runs-on: ubuntu-18.04
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
          architecture: x64
      - name: Checkout Pytorch.github.io
        uses: actions/checkout@v2
      - name: Attempt to download libtorch
        run: |
          python3 scripts/test_libtorch_downloadable.py

  pip-install:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        rel_type: [ "latest_stable", "latest_lts" ]
        acc_type: [ "cuda11.1", "cuda10.2", "accnone" ]
        py_vers: [ "3.7", "3.8", "3.9" ]
        os: ["ubuntu-18.04", "macos-latest"]
    env:
      TEST_ACC: ${{ matrix.acc_type }}
      TEST_VER: ${{ matrix.rel_type }}
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.py_vers }}
          architecture: x64
      - name: Checkout Pytorch.github.io
        uses: actions/checkout@v2
      - name: Test pip3 install
        run: |
          python3 scripts/test_pip_install.py
